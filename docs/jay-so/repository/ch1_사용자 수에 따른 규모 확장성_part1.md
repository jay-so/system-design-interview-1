# 1️⃣ 사용자 수에 따른 규모 확장성 - Part1

---

## 🏠 단일 서버

---

![1.png](..%2F..%2F..%2Fimages%2Fjay-so%2F1%EC%9E%A5%2F1.png)
![2.png](..%2F..%2F..%2Fimages%2Fjay-so%2F1%EC%9E%A5%2F2.png)

- 웹, 앱, 데이터베이스, 캐시 등이 전부 한 대의 서버에서 동작중인 예시입니다.

### 👉🏻 작동 과정

1. 사용자는 도메인 이름을 이용하여 웹 사이트에 접속합니다.
    - 해당 과정을 위해 도메인 이름 서비스(DNS: Domain Name Service)를 이용하여 서버의 IP 주소로 변환합니다.
2. DNS 조회 결과로 IP주소가 반환됩니다.
3. 해당 IP주소로 HTTP(HyperText Transfer Protocol) 요청이 전달됩니다.
4. 요청을 받은 웹 서버는 HTML 페이지나 Json 형태의 응답을 반환합니다.

### 👉🏻 요청 과정

- 웹, 앱 2가지 요청에 대해서 살펴봅시다.
- 웹 서비스: 비즈니스 로직, 데이터 저장을 위해 서버는 구현용 언어(자바, 파이썬)을 사용하고, 클라이언트에게 보여지기 위한 부분은 (HTML, 자바 스크립트)를 사용하여 구현합니다.

- 모바일 앱: 모바일 앱과 웹 서버간 통신을 위해서는 HTTP 프로토콜을 사용합니다.
    - HTTP 프로토콜을 통해서 반환될 응답 데이터의 포맷으로는 주로 JSON(JavaScript Object Notation)이 사용됩니다.

**예시**

id가 12인 사용자 데이터 접근(**GET요청 - `/user/12`** )

``` json
{
	"id":12,
	"firstName": "John",
	"lastName" : "Smith",
	"address" :{
	  "streetAddress": "21 2nd Street",
		"city": "New York",
		"state": "NY",
		"postalCode": 10021
 },
	"phoneNumbers":[
		"212 555-1234",
		"646 555-4567"
 ]
}
```

<br/>

## 😊 데이터베이스

---

![3.png](..%2F..%2F..%2Fimages%2Fjay-so%2F1%EC%9E%A5%2F3.png)

- 사용자가 늘면, 서버는 하나로 충분하지 않아 여러 서버를 두어야 한다.
- 다음과 같이 하나는 웹/ 모바일 트래픽 처리 용도이며, 다른 하나는 데이터베이스 용도처럼 구분됩니다.
- 해당 부분과 같이 웹/모바일 트래픽 처리 서버(웹 계층)과 데이터베이스 서버(데이터 계층)을 분리하면 , 각각 독립적으로 확장할 수 있습니다.

### 👉🏻 데이터 베이스의 구분

- 데이터 베이스는 관계형 데이터 베이스(RDBMS)와 비관계형 데이터베이스으로 구분할 수 있습니다.

**관계형 데이터베이스**

- MySQL, 오라클, PostgreSQL 등이 있습니다.
- 관계형 데이터베이스는 데이터를 테이블과 열, 칼럼으로 표현합니다.
- SQL을 사용한다면, 여러 테이블에 있는 데이터를 관계에 따라 조인하여 합칠 수 있습니다.

**비관계형 데이터베이스**

- Amazon DynamoDB,CouchDB 등이 있습니다.
- 비관계형 데이터베이스는 키-값 저장소, 그래프 저장소, 칼럼 저장소, 문서 저장소로 총 4가지 형태로 구분할 수 있습니다.
- 비관계형 데이터베이스는 일반적으로 조인 연산을 지원하지 않습니다.

비관계형 데이터베이스를 고려하면 좋을때

- 다음과 같은 상황에서는 비관계형 데이터베이스를 고려하는게 좋은 선택일 수 있습니다.

1. 아주 낮은 응답 지연시간이 요구될 때
2. 다루는 데이터가 비정형이라서 관계형 데이터베이스를 도입하기 힘들때
3. 데이터(Json, Yaml, XML 등)을 직렬화하거나, 역직렬화하기면 할 때
4. 아주 많은 양의 데이터를 저장할 필요가 있을 때

<br/>

## 😶‍🌫 수직적 규모 확장 vs 수평적 규모 확장

---

- 수직적 규모 확장이란 서버에 고사양 자원을 추가하여 확장을 의미하며, “스케일 업”이라고 합니다.
- 수평적 규모 확장이란 더 많은 서버를 추가하여 성능을 개선하는 확장을 의미하며, “스케일 아웃”이라고 합니다.

→ 서버로 유입되는 트래픽의 양이 적을 때는 수직적 확장이 좋은 방법이나, 단순함이 장점입니다.

- 그러나 수직적 규모 확장은 다음과 같은 단점이 있습니다.

**수직적 규모 확장의 단점**

1. 수직적 규모 확장에는 한계가 있습니다.
- 한 대의 서버에 CPU나 메모리를 무한대로 증설할 방법이 없다.
- 장애에 대한 자동복구 방안이나 다중화 방안을 제시하지 않는다.
  - 서버에 장애 발생 시 웹 사이트/ 앱은 완전히 중단된다.

→ 이러한 단점 때문에, 대규모 어플리케이션을 지원하는데는 수평적 규모 확장법이 보다 적절합니다.

- 이를 위해 수평적 확장 방법에서는 트래픽을 분산하기 위해사 로드밸런서, 부하 분산기를 도입합니다.

### 👉🏻 로드 밸런서

- 로드 밸런서는 부하 분산 집합에 속한 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할을 합니다.
- 사용자는 로드 밸런서의 공개 IP 주소로 접속합니다.
  - 따라서 웹 서버는 클라이언트의 접속을 직접 처리하지 않습니다.
  - 서버 간의 통신은 사설 IP 주소(Private IP Address)를 이용합니다.

**사설 IP주소**

- 같은 네트워크에 속한 서버 사이의 통신에만 사용되는 IP주소로 인터넷을 통해서는 접속할 수 없습니다.
- 로드밸런서는 웹 서버와 통신하기 위해 사설 IP주소를 사용합니다.

![4.png](..%2F..%2F..%2Fimages%2Fjay-so%2F1%EC%9E%A5%2F4.png)

**로드밸런서의 효과**

- 장애를 자동복구하지 못하는 문제는 해소되며, 웹 계층의 가용성은 향상됩니다.
- 서버 1이 다운되면, 모든 트래픽은 서버2로 전송됩니다.
  - 서버가 다운되는 일을 방지합니다.
  - 부하를 나누기 위해 새로운 서버를 추가할 수 있습니다.
- 웹 사이트로 유입되는 트래픽이 가파르게 증가되면, 더 많은 웹 서버 계층을 추가하여 로드밸런서가 자동으로 트래픽을 분산시킬 수 있습니다.

### 👉🏻 데이터베이스 다중화

- 보통은 여러 데이터 베이스를 사용하여 확장할 때는, DB 서버 간 주(master) - 부(Slave) 관계를 설정하고 데이터 원본은 master에 저장하고, 사본은 slave 서버에 저장됩니다.
- 쓰기 연산은 Master에서만 지원합니다.
- Slave에서는 Master 데이터베이스의 사본을 전달받으며, 읽기 연산만 지원합니다.
- 대부분의 어플리케이션에서는 읽기 연산이 쓰기 연산보다 훨씬 높습니다.
- 따라서 보통의 경우, 여러 Slave 서버를 추가하여 DB의 읽기 부담을 줄여줍니다.

![5.png](..%2F..%2F..%2Fimages%2Fjay-so%2F1%EC%9E%A5%2F5.png)

**데이터 베이스를 다중화하는 장점**

- 성능 향상
  - 쓰기 연산은 Master 서버에, 읽기 연산은 Slave 서버에 나누어 처리함으로써, 병렬로 읽기 연산을 처리할 수 있는 연산이 증가함으로써 성능이 향상됩니다.
- 안정성
  - DB 서버가 외부에 의해 손상이 되어도, 데이터는 보존되는 장점이 있습니다.
- 가용성
  - 데이터를 여러 지역에 복제함으로써, 하나의 데이터베이스 서버에 장애가 발생하더라도, 다른 서버에 있는 데이터를 가져와서 서비스를 지속할 수 있습니다.

**데이터 베이스 중 하나가 다운이 되는 경우**

- **Slave 서버 중 한 개가 다운될 경우**
  - Slave 서버를 새로 확장 시켜, 데이터베이스의 부하를 줄일 수 있습니다.

- **Master 서버가 다운될 경우**
  - Slave 서버 중 하나가 Master 서버로 되체되어 해당 작업을 처리합니다.
  - 그리고 새로운 Slave 서버를 추가합니다.
  - 데이터 일관성을 위해 데이터 복구 처리 로직을 실행하여 추가합니다.

### 👉🏻 로드 밸런서와 데이터베이스 다중화를 고려한 설계

![6.png](..%2F..%2F..%2Fimages%2Fjay-so%2F1%EC%9E%A5%2F6.png)

**동작 과정**

1. 사용자는 DNS로부터 로드밸런서의 공개 IP주소를 받습니다.
2. 사용자는 IP주소를 사용하여 로드밸런서에 접속합니다.
3. HTTP 요청은 서버1이나 서버2로 전달됩니다.
4. 웹 서버는 사용자의 데이터를 Slave 서버에서 읽습니다.
5. 웹 서버의 데이터 변경은 Master 서버에서 이루어집니다.

<br/>

## 🧧 캐시

---

- 캐시는 주로 자주 참조되는 데이터를 메모리 안에 두고, 연속되는 요청에 보다 빨리 처리하기 위한 저장소입니다.

**예시**

- 웹 페이지를 새로고침 할 때마다 표시할 데이터를 가져오기 위해 여러번의 데이터 호출이 일어나는 상황 속, DB 대신 캐시를 통해서 보다 빠르게 조회할 수 있습니다.

**캐시 계층**

- 캐시 계층은 데이터를 잠시 보관되는 곳으로 DB 보다 빠릅니다.
- 별도의 캐시 계층을 두어, 성능 향상과 DB의 부하를 줄어들일 뿐만 아닌 별도의 캐시 계층을 독립적으로 확장하는 것도 가능합니다.

![7.png](..%2F..%2F..%2Fimages%2Fjay-so%2F1%EC%9E%A5%2F7.png)

**읽기 주도형 캐시 전략**

- 요청을 받은 웹 서버는 캐시에 응답이 되어 있는지 살펴봅니다.
- 만약, 캐시에 해당 내용이 저장되어 있다면 해당 데이터를 클라이언트에게 반환합니다.
- 없을 경우, DB에서 조회 후 데이터를 반환합니다.
- 이외에도, 다양한 캐시 전략이 있으며 캐시할 데이터의 종류, 크기, 액세스 패턴에 맞는 캐시 전략을 사용하면 됩니다.

### 👉🏻 캐시 사용 시 유의할 점

- 캐시를 사용할 때는 다음과 같은 부분을 고민하여 사용해야 합니다.

- 데이터 갱신은 자주 일어나지 않지만, 조회가 빈번하게 발생될 때
- 캐시는 휘발성 데이터이기 때문에 영속적으로 기록하는 데이터를 캐시에 두는 상황인가
- 캐시에 보관된 데이터는 언제 만료되어야 하는가?
    - 만료 정책이 없으면 데이터는 캐시에 계속 남게 됩니다.
    - 만료 기한이 너무 짧으면 곤란하여, DB를 너무 자주 읽게 될 상황이 발생합니다.
    - 너무 길어도, 해당 데이터 원본과 차이가 날 가능성이 높습니다.
- 일관성은 어떻게 유지할 것인가?
    - **저장소의 원본을 갱신하는 연산과 캐시를 갱신하는 연산이 단일 트랜잭션으로 처리되지 않을 경우, 해당 일관성은 깨질 수 있습니다.**
    - 이에, 여러 지역에 걸쳐 시스템을 확장해 나가는 경우 캐시와 저장소 사이의 일관성을 유지하는 것이 중요한 점으로 여겨집니다.
- 장애에 대해서 어떻게 대처할 것인가?
    - 캐시 서버를 한 대만 두는 경우, 해당 서버는 단일 장애 지점(SPOF)이 되어버릴 가능성이 있습니다.
    - 따라서 SPOF를 피하려면, 여러 지역에 걸쳐 캐시 서버를 분산시켜야 합니다.

![8.png](..%2F..%2F..%2Fimages%2Fjay-so%2F1%EC%9E%A5%2F8.png)

- 캐시 메모리는 얼마나 잡을 것인가?
    - 캐시 메모리가 너무 작으면 액세스 패턴에 따라서 데이터가 너무 자주 캐시에서 밀려나버려 캐시의 성능이 떨어지게 됩니다.
    - 이를 방지하기 위해 캐시 메모리를 크게 잡아, 갑자기 늘어난 데이터에 대해서도 캐시가 대응가능합니다.
- 데이터 방출 정책은 무엇인가?
    - 캐시가 꽉 차바려면 추가로 캐시에 데이터를 넣어야 할 경우, 기존의 데이터를 내보내야 합니다.
    - 해당 방식을 캐시 데이터 방출 정책이라고 하는데, 가장 널리 사용되는 것이 LRU정책 (가장 사용이 오래된 데이터를 삭제함)이며, LFU정책(가장 사용 빈도가 낮은 데이터를 삭제함)과 함께 FIFO정책(
      가장 먼저 들어온 데이터를 삭제함) 정책이 있으므로 상황에 맞는 것을 사용하면 됩니다.

<br/>

## ⌛ 콘텐츠 전송 네트워크(CDN)

---

- CDN은 주로 정적 콘텐츠를 전송하며, 지리적으로 분산된 서버의 네트워크입니다.
- 이미지, 비디오, CSS, JavaScript 파일 등을 캐시할 수 있습니다.
- 사용자가 웹 사이트를 방문하면, 해당 사용자에게 가장 가까운 CDN 부터 정적 콘텐츠가 전달이 됩니다.
    - 사용자로 부터 먼 CDN 서버로 부터 전달이 되면, 해당 콘텐츠 전달 소요 시간이 길어지게 되어, 가장 가까운 CDN 서버로 부터 전달 받습니다.

![9.png](..%2F..%2F..%2Fimages%2Fjay-so%2F1%EC%9E%A5%2F9.png)

![10.png](..%2F..%2F..%2Fimages%2Fjay-so%2F1%EC%9E%A5%2F10.png)

### 👉🏻 CDN 작동 과정

1. 사용자가 이미지 URL을 통해 image.png에 접근합니다.

- URL의 도메인은 CDN 서비스 사업자가 제공합니다.

2. CDN 서버의 캐시에 해당 이미지가 없는 경우, 서버는 원본 서버에 요청하여 파일을 가져옵니다.

- 원본 서버는 웹 서버일 수도 있고, 아마존 S3 같은 온라인 저장소일 수도 있습니다.

3. 원본 서버가 파일을 CDN 서버에 반환합니다.

- 응답 HTTP 헤더는 해당 파일이 얼마나 오래 캐시할 수 있는지 TTL 값이 들어 있습니다.

4. CDN 서버는 파일을 캐시하고 사용자 A에게 반환합니다.

- 이미지는 TTL에 명시된 시간이 끝날 때까지 캐시 됩니다.

5. 또다른 사용자가 같은 이미지에 대한 요청을 CDN 서버에 전송합니다.
6. 만료되지 않는 이미지에 대한 요청은 캐시를 통해 처리됩니다.

### 👉🏻 CDN 사용 시 고려해야 할 사항

- 비용
    - CDN은 보통 제 3사업자를 통해서 운영되며, CDN으로 들어가고 나오는 데이터 전송의 양에 따라 요금이 부과됩니다.
    - 때문에 자주 사용되지 않는 콘텐츠인지 아닌지 구별한 후 CDN을 사용해야 합니다.
- 적절한 만료 기한 설정
    - 만약, 콘텐츠가 유행에 민감한 콘텐츠라면 기간에 민감함으로 적절한 만료 기간을 설정해야 합니다.
- CDN 장애에 대한 대처 방안
    - 만약, CDN 서비스가 다운되었을 때, 웹 사이트 및 애플리케이션이 어떻게 동작되어야 하는지 고려해야 합니다.
    - CDN 서비스가 동작하지 않을 경우, 해당 문제를 감지하여 원본 서버로부터 직접 콘텐츠를 가져오도록 클라이언트를 구성하는 것이 필요할 수도 있습니다.
- 콘텐츠 무효화 방법
    - CDN에서 아직 만료 기한이 지나지 않았더라도 다음과 같은 방법으로 CDN에서 해당 콘텐츠를 제거할 수 있습니다.
    - CDN 서비스 사업자가 제공하는 API를 이용하여 콘텐츠를 무효화합니다.
    - 콘텐츠의 다른 버전을 서비스하도록 오브젝트 버저닝을 이용, 콘텐츠의 새로운 버전을 지정하기 위해서는 URL 마지막에 버전 번호를 인자로 주면 됩니다.

![11.png](..%2F..%2F..%2Fimages%2Fjay-so%2F1%EC%9E%A5%2F11.png)

<br/>

## 🏃🏻‍ 무상태 웹 계층

---

- 웹 계층을 수평적으로 확장하는 방법입니다.
  - 이를 위해 상태 정보(사용자 세션 데이터 등)은 웹 계층에서 제거해야 합니다.
  - 상태 정보를 관계형 데이터베이스나 NoSQL와 같은 저장소에 저장하고, 필요할 때 가져오는 방식입니다.

→ 이렇게 구성된 웹 계층을 무상태 웹 계층이라고 합니다.

### 👉🏻 상태 정보 의존적인 아키텍처

- 상태 정보를 보관하는 서버는 클라이언트 정보, 즉 상태를 유지하여 요청들 사이에 공유되도록 합니다.

![12.png](..%2F..%2F..%2Fimages%2Fjay-so%2F1%EC%9E%A5%2F12.png)

**예시**

- 사용자 A의 세션 정보나 프로필 이미지 같은 정보는 서버 1에 저장됩니다.
- 사용자 A를 인증하기 위해서는 HTTP 요청은 반드시 서버1로 전송되어야 합니다.
- 마찬가지로 서버2에서는 사용자 B의 세션 정보나 프로필 이미지를 저장하기 때문에 서버2로만 전송되어야 합니다.

**문제점**

- 해당 클라이언트로부터 요청은 항상 해당 클라이언트의 정보를 저장하고 있는 서버로 전송되어야 한다는 문제점이 존재합니다.
- 대부분의 로드밸런서가 이를 지원하기 위해 고정 세션이라는 기능을 제공하고 있는데 이는 로드 밸런서에게 부담을 줍니다.
- 로드 밸런서 뒷단에 서버를 추가하거나 제거하기도 까다로워집니다.
- 또한 서버의 장애를 처리하기에도 복잡합니다.

### 👉🏻 무상태 아키텍처

![13.png](..%2F..%2F..%2Fimages%2Fjay-so%2F1%EC%9E%A5%2F13.png)

- 해당 구조는 사용자로부터 어떤 HTTP요청을 받더라도, 웹 서버로 전달될 수 있습니다.
- 웹 서버는 상태 정보가 필요한 경우 공유 저장소로부터 데이터를 가져옵니다.
- 사용자의 상태 정보는 웹 서버로부터 물리적으로 분리되어 었습니다.
- 해당 구조는 단순하고, 안정적이며, 규모 확장이 쉽습니다.

![14.png](..%2F..%2F..%2Fimages%2Fjay-so%2F1%EC%9E%A5%2F14.png)

- 세션 데이터를 웹 계층에서 분리하고, 지속성 데이터를 보관소에 저장하도록 개선하였습니다.
- 저장소는 RDBMS일 수도 있으며, Redis와 같은 캐시 시스템일 수도 있고, NoSQL일 수도 있습니다.
- 자동 규모 확장이란 트래픽의 양에 따라 웹 서버를 자동으로 추가하거나 삭제하는 기능을 의미합니다.
- 사용자의 상태 정보를 저장하는 로직이 웹 서버로 부터 제거되었으므로, 트래픽의 양에 따라 웹 서버를 넣거나 빼기만 하면 자동으로 규모를 확장할 수 있습니다.


<br/>

## 😝 데이터 센터

---

- 다음은 두 개의 데이터 센터를 이용하는 예시입니다.
- 장애가 없다면, 사용자는 가장 가까운 데이터 센터로부터 안내되는데 해당 과정을 지리적 라우팅이라고 부릅니다.
- 지리적 라우팅에서의 geoDNS는 사용자의 위치에 따라 도메인 이름을 어떤 IP 주소로 변환할지 결정해주는 DNS 서비스입니다.

**예시**

- x% 사용자는 US-East 센터로, 그리고 (100 - x)%의 사용자는 US-West 센터로 안내됩니다.

![15.png](..%2F..%2F..%2Fimages%2Fjay-so%2F1%EC%9E%A5%2F15.png)

- 해당 데이터 센터 중 하나에서 장애가 발생된다면, 모든 트래픽은 장애가 없는 데이터 센터로 전송됩니다.

**예시**

- 장애가 발생되어 US-West에 장애가 발생되어, 모든 트래픽이 US-East 데이터 센터로 전송되는 상황입니다.

![16.png](..%2F..%2F..%2Fimages%2Fjay-so%2F1%EC%9E%A5%2F16.png)

### 👉🏻 다중 데이터 센터 아키텍처를 구성할 때 고려해야 하는 점

- **트래픽 우회**
  - 올바른 데이터 센터로 트래픽을 보내는 효과적인 방법을 찾아야 합니다.
  - Geo DNS는 사용자에게부터 가장 가까운 데이터 센터로 트래픽을 보낼 수 있도록 합니다.

- **데이터 동기화**
  - 데이터 센터마다 별도의 데이터베이스를 사용하고 있는 상황이라면, 장애가 복구되어 트래픽이 다른 데이터베이스로 우회된다고 해도 해당 데이터가 없을 수 있습니다.
  - 이에 여러 데이터 센터를 걸쳐 데이터를 다중화를 해야 합니다.

- **테스트와 배포**
  - 여러 데이터 센터를 사용하도록 시스템이 구성이 되었다면, 여러 위치에서 웹사이트, 모바일 앱 등을 통해 서비스가 정상적으로 운영되는지 테스트해야 합니다.

<br/>

### 📖 Reference

---

[가상 면접 사례로 배우는 대규모 시스템 설계 기초](https://m.yes24.com/Goods/Detail/102819435)